stages:
  - test
  - build
  - infra-plan
  - infra-apply
  - deploy

variables:
  AWS_DEFAULT_REGION: "us-east-1"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Test stage
test:frontend:
  stage: test
  image: node:18
  script:
    - cd frontend
    - npm install
    - npm run lint
    - npm run build
  only:
    - merge_requests
    - main

test:backend:
  stage: test
  image: python:3.11
  script:
    - cd backend
    - pip install -r requirements.txt
    - pip install pytest pytest-asyncio
    - pytest tests/ -v
  only:
    - merge_requests
    - main

# Build stage
build:frontend:
  stage: build
  image: node:18
  script:
    - cd frontend
    - npm install
    - npm run build
  artifacts:
    paths:
      - frontend/dist/
    expire_in: 1 hour
  only:
    - main

build:backend:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - apk add --no-cache aws-cli
    - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
  script:
    - cd backend
    - docker build -t $ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:latest .
    - docker push $ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:latest
  only:
    - main

build:frontend:docker:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - apk add --no-cache aws-cli
    - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
  script:
    - cd frontend
    - docker build -t $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:latest .
    - docker push $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:latest
  only:
    - main

# Infrastructure plan stage
infra:plan:
  stage: infra-plan
  image: hashicorp/terraform:latest
  before_script:
    - cd infra/terraform
    - terraform init
  script:
    - terraform plan -out=tfplan
  artifacts:
    paths:
      - infra/terraform/tfplan
    expire_in: 1 week
  only:
    - merge_requests
    - main

# Infrastructure apply stage (manual)
infra:apply:
  stage: infra-apply
  image: hashicorp/terraform:latest
  before_script:
    - cd infra/terraform
    - terraform init
  script:
    - terraform apply -auto-approve tfplan
  dependencies:
    - infra:plan
  when: manual
  only:
    - main

# Deploy stage
deploy:frontend:
  stage: deploy
  image: amazon/aws-cli:latest
  script:
    - aws s3 sync frontend/dist/ s3://$S3_BUCKET_FRONTEND/ --delete
    - echo "Frontend deployed to S3"
  dependencies:
    - build:frontend
  only:
    - main

deploy:backend:
  stage: deploy
  image: amazon/aws-cli:latest
  script:
    - echo "Backend deployment to EKS would go here"
    - echo "Update Kubernetes deployment with new image"
    # - kubectl set image deployment/ragledger-backend backend=$ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:latest
  dependencies:
    - build:backend
  only:
    - main

